---
title: "Abundance Plot"
output: html_document
date: "2024-09-20"
---

```{r setup, include = FALSE}
options (width = 100)
knitr::opts_chunk$set(warning = FALSE, meassage = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

```{r}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(ggplot2)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(NCmisc)
library(RColorBrewer)

```

```{r}

##load merged file 
seuratM <- readRDS("~/Desktop/Emily/Myocarditis snRNAseq/data/01 Merged Seurat files/Myocarditis_allfiltered_19.09.24.rds")

table(seuratM$dataset)
table(seuratM$RNA_snn_res.0.25)
table(seuratM$orig.ident)

```




```{r Plot umap}

Idents(seuratM) <- seuratM$RNA_snn_res.0.25
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

seuratM$clusterName <- "clusterName"

seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "0" )] <- "Fb1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "1" )] <- "BEC1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "2" )] <- "PeriFb1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "3" )] <- "Cardiomyocyte"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "4" )] <- "MCP1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "5" )] <- "TC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "6" )] <- "MCP2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "7" )] <- "BEC2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "8" )] <- "VSMC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "9" )] <- "NC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "10" )] <- "Fb2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "11" )] <- "Fb3"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "12" )] <- "INT1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "13" )] <- "PeriFb2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "14" )] <- "PeriFb3"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "15" )] <- "AdipoC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "16" )] <- "Unknown"


DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

### Order of Clusters
Idents(seuratM) <- seuratM$clusterName
#seuratM$clusterName <- factor(seuratM$clusterName, levels =c("Cardiomyocyte","Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "MCP1","MCP2","TC", "BEC1","BEC2", "AdipoC", "Unknown"))

seuratM$clusterName <- factor(seuratM$clusterName, levels =c("TC", "MCP1","MCP2","Cardiomyocyte","Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "BEC1","BEC2", "AdipoC", "Unknown"))


table(seuratM$clusterName)

### Order of Conditions
Idents(seuratM) <- seuratM$pat_sub
order1 <- c("Healthy","AM","CMP","Sarcoidosis")
seuratM$pat_sub <- factor (seuratM$pat_sub, levels = c("Healthy", "AM", "CMP", "Sarcoidosis"))
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, group.by = "pat_sub")


# Order of patients 
seuratM$patient <- factor(seuratM$patient, levels = c("Healthy 01", "Healthy 02", "Healthy 03", "Healthy 04", "Healthy 05", "Healthy 06", "Healthy 07", "Healthy 08", "Healthy 09", "Healthy 10", "AM 01", "AM 02", "AM 03", "AM 04", "AM 05", "AM 06", "AM 07", "AM 08", "AM 09", "AM 10", "AM 11", "AM 12", "AM 13", "AM 14", "AM 15", "AM 16", "AM 17", "AM 18", "CMP 01", "CMP 02", "CMP 03", "CMP 04", "CMP 05", "CMP 06", "CMP 07", "CMP 08", "CMP 09", "CMP 10", "CMP 11", "CMP 12", "CMP 13", "Sarcoidosis 01","Sarcoidosis 02"))

Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

```

```{r}

```




```{r Select color scheme and change order for relative abundances } 
seuratM$clusterName <- factor(seuratM$clusterName, levels =c("TC", "MCP1","MCP2","Cardiomyocyte","Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "BEC1","BEC2", "AdipoC", "Unknown"))

##set color vectors

colclusterName <- c( "#dd1c77", "#67001f", "#fde0dd","#D53E4F", "#f4a582", "#FEE08B","#feb24c", "#003c30","#01665e","#66C2A5", "#3288BD","#BEAED4", "#c7eae5","#355C7D", "#202547","#B45B5C","#8c510a")

                    
names(colclusterName) <- c("TC", "MCP1","MCP2","Cardiomyocyte","Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "BEC1","BEC2", "AdipoC", "Unknown")


colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")

coldiseaseCond <- colpat_sub
names(coldiseaseCond) <- c("Healthy", "AM", "CMP", "Sarcoidosis")
order_coldiseaseCond <- c("Healthy", "AM", "CMP", "Sarcoidosis")

head(seuratM@meta.data)

DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

```
```{r}

colclusterName <- c("#D53E4F", "#f4a582", "#FEE08B","#feb24c","#67001f", "#01665e","#66C2A5","#c7eae5","#BEAED4", "#355C7D","#3288BD","#8c510a" ,"#fde0dd","#B45B5C","#dd1c77")

                    
names(colclusterName) <- c("Cardiomyocyte","Fb1","Fb2","Fb3", "INT1", "PeriFb1", "PeriFb2", "VSMC","NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2","TC")

colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")

seuratM$clusterName <- factor(seuratM$clusterName, levels=c("Cardiomyocyte", "Fb1", "Fb2", "Fb3", "INT1","PeriFb1", "PeriFb2", "VSMC", "NC", "BEC1", "BEC2", "AdipoC", "MCP1", "MCP2", "TC"))


Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE, cols = colclusterName)

unique(seuratM$clusterName)

```

```{r create heatmap}

## Create Heatmap

Idents(seuratM) <- seuratM$clusterName
seuratM$clusterName <- factor(seuratM$clusterName, levels =c("Cardiomyocyte","Fb1","Fb2","Fb3", "INT1","PeriFb1", "PeriFb2","VSMC","NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2", "TC"))

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "TNNT2", "CMYA5", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB", "BMP4", "GREM1", "ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "PLIN1", "GPAM", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "HLA-DQB1","CCR2", "CD79B","JCHAIN", "IL7R", "CD3E", "PTPRC", "CD2"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 


avgHeatmap <- function(seuratM, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seuratM)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seuratM)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seuratM)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      celltype=colVec)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
  ordVec <- levels(seuratM)
  ordVec <- c("Cardiomyocyte","Fb1","Fb2","Fb3","INT1", "PeriFb1", "PeriFb2","VSMC", "NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2", "TC")
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0,cluster_rows = cr, 
         cluster_cols = cc, color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=c("TTN", "MYBPC3", "RYR2", "NEBL", "TNNT2", "CMYA5", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB", "BMP4", "GREM1", "ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "PLIN1", "GPAM", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "HLA-DQB1", "CCR2", "CD79B","JCHAIN", "IL7R","CD3E", "PTPRC", "CD2"))

levels(seuratM)


colVec <- colclusterName

# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")

avgHeatmap(seuratM, selGenes = genesPlot, colVecIdent = colVec)


```

```{r Relative expression BMP4}

```{r create heatmap}

## Create Heatmap

Idents(seuratM) <- seuratM$clusterName
seuratM$clusterName <- factor(seuratM$clusterName, levels =c("Cardiomyocyte","Fb1","Fb2","Fb3", "INT1","PeriFb1", "PeriFb2","VSMC","NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2", "TC"))

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "TNNT2", "CMYA5", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB", "BMP4", "GREM1", "ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "PLIN1", "GPAM", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "HLA-DQB1","CCR2", "CD79B","JCHAIN", "IL7R", "CD3E", "PTPRC", "CD2"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 


avgHeatmap <- function(seuratM, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seuratM)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seuratM)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seuratM)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      celltype=colVec)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
  ordVec <- levels(seuratM)
  ordVec <- c("Cardiomyocyte","Fb1","Fb2","Fb3","INT1", "PeriFb1", "PeriFb2","VSMC", "NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2", "TC")
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0,cluster_rows = cr, 
         cluster_cols = cc, color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=c("TTN", "MYBPC3", "RYR2", "NEBL", "TNNT2", "CMYA5", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB", "BMP4", "GREM1", "ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "PLIN1", "GPAM", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "HLA-DQB1", "CCR2", "CD79B","JCHAIN", "IL7R","CD3E", "PTPRC", "CD2"))

levels(seuratM)


colVec <- colclusterName

# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")

avgHeatmap(seuratM, selGenes = genesPlot, colVecIdent = colVec)


```





```{r}
## different order

# old order: seuratM$clusterName <- factor(seuratM$clusterName, levels =c("Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "BEC1","BEC2", "AdipoC", "Unknown" ,"Cardiomyocyte","MCP2","MCP1","TC"))

##set color vectors

colclusterName <- c( "#dd1c77", "#67001f", "#fde0dd","#D53E4F", "#f4a582", "#FEE08B","#feb24c", "#003c30","#01665e","#66C2A5", "#3288BD","#BEAED4", "#c7eae5","#355C7D", "#202547","#B45B5C","#8c510a","#67001f", "#dd1c77")

                    
names(colclusterName) <- c("TC", "MCP1","MCP2","Cardiomyocyte","Fb1","Fb2","Fb3", "PeriFb1", "PeriFb2","PeriFb3","VSMC", "INT1","NC", "BEC1","BEC2", "AdipoC", "Unknown")


colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")

coldiseaseCond <- colpat_sub
names(coldiseaseCond) <- c("Healthy", "AM", "CMP", "Sarcoidosis")
order_coldiseaseCond <- c("Healthy", "AM", "CMP", "Sarcoidosis")

head(seuratM@meta.data)

DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE, cols = colclusterName)


```



```{r}

###combined slots
seuratM$clusterName_patsub <- paste0(seuratM$clusterName, '_', seuratM$pat_sub)
table(seuratM$clusterName_patsub)


```


```{r Plot abundance Plot for each patient}
datList <- NULL
for(con in unique(seuratM$patient)){
  seuratSub <- subset(seuratM, patient==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient=con)
  datList[[con]] <- dat_con
}


dat_all <- do.call("rbind", datList)

# Order of patient levels 
patient_order <- c("Healthy 01", "Healthy 02", "Healthy 03", "Healthy 04", "Healthy 05", 
                   "Healthy 06", "Healthy 07", "Healthy 08", 
                   "AM 01", "AM 02", "AM 03", "AM 04", "AM 05", "AM 06", "AM 07", 
                   "AM 08", "AM 09", "AM 10", "AM 11", "AM 12", "AM 13", "AM 14", 
                   "AM 15", "AM 16", "AM 17", "AM 18", "CMP 01", "CMP 02", "CMP 03", 
                   "CMP 04", "CMP 05", "CMP 06", "CMP 07", "CMP 08", "CMP 09", 
                   "CMP 10", "CMP 11", "CMP 12", "CMP 13", "Sarcoidosis 01", "Sarcoidosis 02")

View(dat_all)

#write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_frequency_relative abundance_V3_without HH2 and HH3", sep = "\t",quote=F,row.names=T,col.names=T)


# Convert the patient column to a factor with the desired order
dat_all$patient <- factor(dat_all$patient, levels = patient_order)

## plot abundance
ggbarplot(dat_all, x= "patient", y= "percent", fill = "Var1", legend = "right", legend.titel = "cluster", ylab = "frequency", palette = colclusterName )  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r Plot abundance Plot for each patient}
## abundance in descending TC order

# Subset TC cluster
dat_tc <- dat_all[dat_all$Var1 == "TC", ]

# Reorder the patients based on the percentage of T cells in descending order
dat_all$patient <- factor(dat_all$patient, levels = dat_tc$patient[order(-dat_tc$percent)])

## Plot abundance for TC
ggbarplot(dat_all, x= "patient", y= "percent", fill = "Var1", legend = "right", legend.titel = "cluster", ylab = "frequency", palette = colclusterName )  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

## abundance in descending macrophage 2 order
dat_mcp2 <- dat_all[dat_all$Var1 == "MCP2", ]

# Reorder the patients based on the percentage of MCP2 in descending order
dat_all$patient <- factor(dat_all$patient, levels = dat_mcp2$patient[order(-dat_mcp2$percent)])

ggbarplot(dat_all, x= "patient", y= "percent", fill = "Var1", legend = "right", legend.titel = "cluster", ylab = "frequency", palette = colclusterName )  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r Plot abundance according to each condition. }


###diseaseCond
datList <- NULL
for(con in unique(seuratM$pat_sub)){
  seuratSub <- subset(seuratM, pat_sub==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(diseaseCond=con)
  datList[[con]] <- dat_con
  
}

dat_all <- do.call("rbind", datList)

# Plot abundacne according to disease condition (=pat_sub)

ggbarplot(dat_all, x = "diseaseCond", y = "percent", fill = "Var1", palette = colclusterName, legend = "right", legend.titel = "cluster", xlab = "condition", ylab = "frequency") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_discrete(limits = order_coldiseaseCond)

colnames(dat_all)

# frequency per condition
#dat_condition <- dat_all %>%
  #group_by(diseaseCond, Var1) %>%                       # Group by disease condition and cluster
 # summarise(total_Freq = sum(Freq)) %>%                 # Summarize the total frequency for each cluster per condition
 # mutate(percent = total_Freq / sum(total_Freq)) %>%    # Calculate percentage of each cluster per condition
  #ungroup()

#View(dat_condition)

```






```


```

```



```{r Filter patients with T cell high >6%, intermediate 2-6% and low <2% from each patient}
datList <- NULL
for(con in unique(seuratM$patient)){
  seuratSub <- subset(seuratM, patient==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient=con)
  datList[[con]] <- dat_con
}


dat_all <- do.call("rbind", datList)
```


```{r Filter patients with T cell high >6%, intermediate 2-6% and low <2% from each patient}
# Filter for T cell cluster ("TC")
dat_all <- filter(dat_all, Var1 == "TC")

# Classify patients based on T cell frequency
dat_all$Tgrp <- NA  # New column

# Assign T cell categories
dat_all$Tgrp[dat_all$percent > 0.06] <- "Tcell High > 6%"
dat_all$Tgrp[dat_all$percent <= 0.06 & dat_all$percent >= 0.02] <- "Tcell Intermediate 2-6%"
dat_all$Tgrp[dat_all$percent < 0.02] <- "Tcell Low < 2%"

# Verify the classification
table(dat_all$Tgrp)

# Combine slots for the seuratM object
seuratM$Tgrp_patient <- paste0(dat_all$Tgrp, '_', dat_all$patient)

# Create a summary table to count Tgrp per patient
table(seuratM$Tgrp_patient)

## TcellHigh = 9, Tcell Int = 13, TcellLow = 21

#write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_Tcell_high_low", sep = "\t",quote=F,row.names=F,col.names=T)

ggplot(dat_all, aes(x = Tgrp, y = percent, fill = Tgrp)) +
  geom_point(binaxis = 'y', stackdir = 'center', dotsize = 1, position = position_dodge(0.75)) +  # Adjust parameters as needed
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +  # X-axis label
  ylab("Frequency (Cell Count per patient)")  # Y-axis label


ggplot(dat_all, aes(x = Tgrp, y = percent, fill = Tgrp)) +
  geom_boxplot() +
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +  # X-axis label
  ylab("Frequency (Cell Count per patient)")  # Y-axis label


ggplot(dat_all, aes(x = Tgrp, y = percent, fill = Tgrp)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, position = position_dodge(0.75)) +  # Adjust parameters as needed
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +  # X-axis label
  ylab("Frequency (Cell Count per patient)")  # Y-axis label


# Create the plot
ggplot(dat_all, aes(x = Tgrp, y = percent, fill = Tgrp)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +  # Box plot without outliers
  geom_jitter(size = 2, width = 0.2, aes(color = Tgrp)) +  # Jittered points
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +
  ylab("T Cell Frequency") +
  stat_compare_means(method = "anova", label = "p.signif", hide.ns = TRUE)  # ANOVA test

# Create the plot
ggplot(dat_all, aes(x = Tgrp, y = percent, fill = Tgrp)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +  # Box plot without outliers
  geom_jitter(size = 0.8, width = 0.2, aes(color = Tgrp)) +  # Jittered points
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +
  ylab("T Cell Frequency") +
  stat_compare_means(method = "anova", label = "p.signif", hide.ns = FALSE) +
  stat_compare_means(label = "p.format", comparisons = list(c("Tcell High > 6%", "Tcell Intermediate 2-6%", "Tcell Low < 2%")), method = "kruskal")  # Kruskal


ggplot(dat_all, aes(x = Tgrp, y = percent, color = Tgrp)) +
  geom_jitter(size = 2, width = 0.2) +  # Jitter to prevent overlap
  theme_classic() +
  ggtitle("Frequencies of T cells") +
  xlab("T cell groups") +
  ylab("Frequency (Cell Count per patient)")



```


```{r Filter inflammatory macrophages MCP2 and perform the same as for TC}
datList <- NULL
for(con in unique(seuratM$patient)){
  seuratSub <- subset(seuratM, patient==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient=con)
  datList[[con]] <- dat_con
}


dat_all <- do.call("rbind", datList)


View(dat_all)


# Filter MCP2 cluster and subgroup into high, intermediate and low

dat_all <- filter (dat_all, Var1 == c("MCP2"))

dat_all$MCP2grp <- NA

dat_all$MCP2grp[dat_all$percent > 0.05] <- "MCP2 High > 5%"
dat_all$MCP2grp[dat_all$percent <= 0.05 & dat_all$percent >= 0.01] <- "MCP2 Intermediate 1-5%"
dat_all$MCP2grp[dat_all$percent < 0.01] <- "MCP2 Low <1%"

seuratM$MCP2grp_patient <- paste0(dat_all$MCP2grp, '_', dat_all$patient)

table(dat_all$MCP2grp)
#write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_MCP2_high_low", sep = "\t",quote=F,row.names=F,col.names=T)

# MCP2 --> 2 high, 6 intermediate, 35 low

# Create the plot
ggplot(dat_all, aes(x = MCP2grp, y = percent, fill = MCP2grp)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +  # Box plot without outliers
  geom_jitter(size = 0.5, width = 0.2, aes(color = MCP2grp)) +  # Jittered points
  theme_classic() +
  ggtitle("Frequencies of the Macrophages type 2 - inflammatory subtype") +
  xlab("MCP2 groups") +
  ylab("MCP2 Frequency") +
  stat_compare_means(method = "anova", label = "p.signif", hide.ns = FALSE) +
  stat_compare_means(label = "p.format", comparisons = list(c("MCP2 High > 5%", "MCP2 Intermediate 1-5%", "MCP2 Low <1%"), method = "kruskal"))

```


```{r Filter inflammatory macrophages MCP2 and perform the same as for TC}

datList <- NULL
for(con in unique(seuratM$patient)){
  seuratSub <- subset(seuratM, patient==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient=con)
  datList[[con]] <- dat_con
}


dat_all <- do.call("rbind", datList)


View(dat_all)

# Filter MCP1
dat_all <- filter(dat_all, Var1 == ("MCP1"))

dat_all$MCP1grp <- NA

dat_all$MCP1grp [dat_all$percent > 0.12] <- "MCP1 High > 12%"
dat_all$MCP1grp [dat_all$percent <= 0.12 & dat_all$percent >=0.06] <- "MCP1 Intermediate 6-12%"
dat_all$MCP1grp [dat_all$percent < 0.06] <- "MCP1 Low <6%"

seuratM$MCP1grp <- paste0(dat_all$MCP1grp, '_', dat_all$patient)

table(dat_all$MCP1grp)


write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_MCP1_high_low", sep = "\t",quote=F,row.names=F,col.names=T)

## MCP1 High = , MCP1 Low = ,

View(dat_all)

#write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_Tcell_high_low", sep = "\t",quote=F,row.names=F,col.names=T)

# Create the plot
ggplot(dat_all, aes(x = MCP1grp, y = percent, fill = MCP1grp)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +  # Box plot without outliers
  geom_jitter(size = 0.5, width = 0.2, aes(color = MCP1grp)) +  # Jittered points
  theme_classic() +
  ggtitle("Frequencies of the Macrophages type 1 - resident macrophages") +
  xlab("MCP1 groups") +
  ylab("MCP1 Frequency") +
  stat_compare_means(method = "anova", label = "p.signif", hide.ns = FALSE) +
  stat_compare_means(label = "p.format", comparisons = list(c("MCP1 High > 12%", "MCP1 Intermediate 6-12%", "MCP1 Low <6%"), method = "kruskal"))

```


```{r Filter Fb2}

datList <- NULL
for(con in unique(seuratM$patient)){
  seuratSub <- subset(seuratM, patient==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient=con)
  datList[[con]] <- dat_con
}


dat_all <- do.call("rbind", datList)


View(dat_all)

# Filter Fb2
dat_all <- filter(dat_all, Var1 == ("Fb2"))

View(dat_all) 
dat_all$Fb2grp <- NA

dat_all$Fb2grp  [dat_all$percent >= 0.01] <- "Fb2 High >= 1%"
dat_all$Fb2grp  [dat_all$percent < 0.01] <- "Fb2 Low < 1%"

seuratM$Fb2grp <- paste0(dat_all$Fb2grp, '_', dat_all$patient)

table(dat_all$Fb2grp)



write.table(dat_all, file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_dat_all_clusters_Fb2 Fibroblasts_high_low", sep = "\t",quote=F,row.names=F,col.names=T)

## Fb2 High = , Fb Intermediate = , Fb2 Low = ,

View(dat_all)


# Create the plot
ggplot(dat_all, aes(x = Fb2grp, y = percent, fill = Fb2grp)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +  # Box plot without outliers
  geom_jitter(size = 2, width = 0.2, aes(color = Fb2grp)) +  # Jittered points
  theme_classic() +
  ggtitle("Frequencies of Fibroblasts type 2 - proinflammatory subtype") +
  xlab("Fb2 groups") +
  ylab("Fb2 Frequency") +
  stat_compare_means(method = "anova", label = "p.signif", hide.ns = FALSE) +
  stat_compare_means(label = "p.format", comparisons = list(c("Fb2 High > 6%", "Fb2 Intermediate 2-6%", "Fb2 Low <2%"), method = "kruskal"))

```







```{r Plot abundance according to each condition}


###diseaseCond
datList <- NULL
for(con in unique(seuratM$pat_sub)){
  seuratSub <- subset(seuratM, pat_sub==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clusterName)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(diseaseCond=con)
  datList[[con]] <- dat_con
  
}

dat_all <- do.call("rbind", datList)

# Plot abundacne according to disease condition (=pat_sub)

ggbarplot(dat_all, x = "diseaseCond", y = "percent", fill = "Var1", palette = colclusterName, legend = "right", legend.titel = "cluster", xlab = "condition", ylab = "frequency") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_discrete(limits = order_coldiseaseCond)

colnames(dat_all)

# frequency per condition
#dat_condition <- dat_all %>%
  #group_by(diseaseCond, Var1) %>%                       # Group by disease condition and cluster
 # summarise(total_Freq = sum(Freq)) %>%                 # Summarize the total frequency for each cluster per condition
 # mutate(percent = total_Freq / sum(total_Freq)) %>%    # Calculate percentage of each cluster per condition
  #ungroup()

#View(dat_condition)

```






```


```






```










