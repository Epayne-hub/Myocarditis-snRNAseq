
---
title: "Myocarditis snRNAseq QC, Merging and Marker Genes"
output: 
html_document:
keep_md: true
toc: true
editor_options:
chunk_output_type: inline

date: "2024-09-09"
---

```{r setup, include = FALSE}

options (width = 100)
knitr::opts_chunk$set(warning = FALSE, meassage = FALSE, dev = c("png", "pdf"))
seed <- 1234

```



```{r Load all required packages}

library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(NCmisc)

```

```{r Load all files and merge data to seuratS object: file folders: AM, CM, Sarcoidosis, Healthy}

### load files AM and merge
basedir <- "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/AM"
fileNamList <- list.files(path = basedir)


for(i in 1:length(fileNamList)){
  seuratS <- readRDS(paste0(basedir,"/", fileNamList[i]))
  if(exists("seuratM")){
    seuratM <- merge(x = seuratM, y = seuratS)
  }else{
    seuratM <- seuratS
  }
}

##
#
remove(seuratS)
table(seuratM$dataset)
table(seuratM$orig.ident)


### load files Berlin and merge
basedir <- "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/Berlin"
fileNamList <- list.files(path = basedir)

for(i in 1:length(fileNamList)){
  seuratS <- readRDS(paste0(basedir, "/", fileNamList[i]))
  if(exists("seuratM")){
    seuratM <- merge(x = seuratM, y = seuratS)
  }else{
    seuratM <- seuratS
  }
}

##
#
remove(seuratS)
table(seuratM$dataset)
table(seuratM$orig.ident)

### load files CM and merge
basedir <- "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/CM"
fileNamList <- list.files(path = basedir)

for(i in 1:length(fileNamList)){
 seuratS <- readRDS(paste0(basedir, "/", fileNamList[i]))
  if(exists("seuratM")){
    seuratM <- merge(x = seuratM, y = seuratS)
  }else{
    seuratM <- seuratS
  }
}

##
#
remove(seuratS)
table(seuratM$dataset)
table(seuratM$orig.ident)


### load files from healthy donors and merge

basedir <- "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/Healthy"
fileNamList <- list.files(path = basedir)

for(i in 1:length(fileNamList)){
  seuratS <- readRDS(paste0(basedir, "/", fileNamList[i]))
  if(exists("seuratM")){
    seuratM <- merge(x = seuratM, y = seuratS)
  }else{
    seuratM <- seuratS
  }
}

##
#
remove(seuratS)
table(seuratM$dataset)
table(seuratM$orig.ident)

## load files from Sarcoidosis patients and merge
basedir <- "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/Sarcoidosis"
fileNamList <- list.files(path = basedir)

for(i in 1:length(fileNamList)){
  seuratS <- readRDS(paste0(basedir, "/", fileNamList[i]))
  if(exists("seuratM")){
    seuratM <- merge(x = seuratM, y = seuratS)
  }else{
    seuratM <- seuratS
  }
}

## total cell count 90517
##
#
remove(seuratS)
table(seuratM$dataset)
table(seuratM$orig.ident)

```



```{r}

#### Load all seurat files. Name patient_ID and allocate to condition


### Healthy heart
HH_1 <- c("o28576_1_08-8_20220525_Hu_nucseq_Graz_8_HH_GEM")
HH_2 <- c("o28576_1_10-10_20220525_Hu_nucseq_Graz_10_HH_GEM")
HH_3 <- c("o28576_1_11-11_20220525_Hu_nucseq_Graz_11_HH_GEM")
HH_4 <- c("o28576_1_12-12_20220525_Hu_nucseq_Graz_12_HH_GEM")
HH_5 <- c("o292731_1-1_20220818_Hu_nucseq_Graz_9_HH_GEM")
HH_6 <- c("o292731_2-2_20220818_Hu_nucseq_Graz_13_HH_GEM")
HH_7 <- c("o294781_01-1_20220912_Hu_nucseq_Graz_21_HH_GEM")
HH_8 <- c("o294781_02-2_20220912_Hu_nucseq_Graz_22_HH_GEM")
HH_9 <- c("o294781_03-3_20220912_Hu_nucseq_Graz_23_HH_GEM")
HH_10 <- c("o294781_04-4_20220912_Hu_nucseq_Graz_24_HH_GEM")
HH_11 <- c("o28576_1_09-9_20220525_Hu_nucseq_Graz_9_HH_GEM")

## AM # 39 bad quality remove later
Immpath_2 <- c("o292731_3-3_20220818_Hu_nucseq_SG_33_EMB_GEM")
Immpath_10 <- c("312581_05-5_20230308_Hu_nucseq_SG36_EMB_GEM")
Immpath_12 <- c("312581_06-6_20230308_Hu_nucseq_SG37_EMB_GEM")
Immpath_14 <- c("312581_07-7_20230308_Hu_nucseq_SG38_EMB_GEM")
Immpath_18 <- c("353921_28-28_20240529_Hu_nucseq_Immpath_EMB18")
Immpath_27 <- c("353921_31-31_20240529_Hu_nucseq_Immpath_EMB27")
Immpath_29 <- c("353921_32-32_20240529_Hu_nucseq_Immpath_EMB29")
Immpath_35 <- c("353921_34-34_20240529_Hu_nucseq_Immpath_EMB35")
Immpath_37 <- c("353921_35-35_20240529_Hu_nucseq_Immpath_EMB37")
Immpath_47 <- c("359861_16-8_20240730_Hu_nucseq_Immpath_EMB47")
Immpath_48 <- c("359861_17-9_20240730_Hu_nucseq_Immpath_EMB48")
Immpath_39 <- c("347741_6-6_20240326_Hu_nucseq_Immpath_AM39_0", "348751_1-6_20240326_Hu_nucseq_Immpath_AM39_0_rep")


pat_NCRGraz1 <- c("o28576_1_01-1_20220525_Hu_nucseq_Graz_1_EMB_GEM")
pat_NCRGraz2 <- c("o28576_1_02-2_20220525_Hu_nucseq_Graz_2_EMB_GEM")
pat_NCRGraz15 <- c("o294781_06-6_20220912_Hu_nucseq_Graz_15_EMB_GEM")
pat_NCR29 <- c("o27533_1_11-11_20220203_Hu_nucseq_EMB30_GEM")
pat_NCR30 <- c("o27533_1_12-12_20220203_Hu_nucseq_EMB31_GEM")
pat_NCR31 <- c("o27936_1_7-7_20220309_Hu_nucseq_EMB32_GEM")


pat_BLn979 <- c("359861_09-11_20240723_Hu_nucseq_Ber_Pat5_EM979_1","359861_10-13_20240723_Hu_nucseq_Ber_Pat5_EM979_2")
pat_BLn1537 <- c("359861_11-1_20240730_Hu_nucseq_Ber_Pat1_EMB1537")
pat_BLn1041 <- c("359861_12-2_20240730_Hu_nucseq_Ber_Pat2_EMB1041")
pat_BLn1235 <- c("359861_13-5_20240730_Hu_nucseq_Ber_Pat6_EMB1235")
pat_BLn1383<- c("359861_14-6_20240730_Hu_nucseq_Ber_Pat7_EMB1383")
pat_BLn694 <- c("359861_15-7_20240730_Hu_nucseq_Ber_Pat8_EMB694")


## CMP 
Immpath_24 <- c("353921_29-29_20240529_Hu_nucseq_Immpath_EMB24")
Immpath_25 <- c("353921_30-30_20240529_Hu_nucseq_Immpath_EMB25")
Immpath_30 <- c("353921_33-33_20240529_Hu_nucseq_Immpath_EMB30")
pat_NCR32 <- c ("o28576_1_13-13_20220525_Hu_nucseq_EMB32_GEM")
pat_NCR34 <- c("o292731_4-4_20220818_Hu_nucseq_SG_34_EMB_GEM")
CM_Graz7 <- c("o28576_1_07-7_20220525_Hu_nucseq_Graz_7_EMB_GEM")
CM_Graz14 <- c("o294781_05-5_20220912_Hu_nucseq_Graz_14_EMB_GEM")
CM_Graz18 <- c("o294781_09-9_20220912_Hu_nucseq_Graz_18_EMB_GEM")
CM_Graz3 <- c("o28576_1_03-3_20220525_Hu_nucseq_Graz_3_EMB_GEM")
CM_Graz4 <- c("o28576_1_04-4_20220525_Hu_nucseq_Graz_4_EMB_GEM")
CM_Graz5 <- c("o28576_1_05-5_20220525_Hu_nucseq_Graz_5_EMB_GEM")
CM_Graz6 <- c("o28576_1_06-6_20220525_Hu_nucseq_Graz_6_EMB_GEM")
CM_Graz19 <- c("o294781_10-10_20220912_Hu_nucseq_Graz_19_EMB_GEM")

##Sarcoidosis
Sarco_SG35 <- c("o292731_5-5_20220818_Hu_nucseq_SG_35_EMB_GEM")
Sarco_Graz20 <- c("o294781_11-11_20220912_Hu_nucseq_Graz_20_EMB_GEM")


### changes compared to before: 
# NCR32 and NCR 34 are now labelled as CM
# Immpath-02 = SG 36, Immpath-10 = SG37
##labels of pat_NCR are one next higher up
# pat_NCR29 <- c("o27533_1_11-11_20220203_Hu_nucseq_EMB30_GEM")
# pat_NCR30 <- c("o27533_1_12-12_20220203_Hu_nucseq_EMB31_GEM")
# pat_NCR31 <- c("o27936_1_7-7_20220309_Hu_nucseq_EMB32_GEM")
# Immpath_30 <- c("353921_33-33_20240529_Hu_nucseq_Immpath_EMB30") different seurat


## Name samples
seuratM$patient <- "pat_nr"

##Healthy
seuratM$patient[which(seuratM$dataset %in% HH_1)] <- "Healthy 01"
seuratM$patient[which(seuratM$dataset %in% HH_4)] <- "Healthy 02"
seuratM$patient[which(seuratM$dataset %in% HH_5)] <- "Healthy 03"
seuratM$patient[which(seuratM$dataset %in% HH_6)] <- "Healthy 04"
seuratM$patient[which(seuratM$dataset %in% HH_7)] <- "Healthy 05"
seuratM$patient[which(seuratM$dataset %in% HH_8)] <- "Healthy 06"
seuratM$patient[which(seuratM$dataset %in% HH_9)] <- "Healthy 07"
seuratM$patient[which(seuratM$dataset %in% HH_10)] <-"Healthy 08"
seuratM$patient[which(seuratM$dataset %in% HH_11)] <-"Healthy 09"
seuratM$patient[which(seuratM$dataset %in% HH_2)] <- "Healthy 10"
seuratM$patient[which(seuratM$dataset %in% HH_3)] <- "Healthy 11"

seuratM$patient[which(seuratM$dataset %in% Immpath_2)] <- "AM 01"
seuratM$patient[which(seuratM$dataset %in% Immpath_10)] <- "AM 02"
seuratM$patient[which(seuratM$dataset %in% Immpath_12)] <- "AM 03"
seuratM$patient[which(seuratM$dataset %in% Immpath_18)] <- "AM 04"
seuratM$patient[which(seuratM$dataset %in% Immpath_27)] <- "AM 05"
seuratM$patient[which(seuratM$dataset %in% Immpath_29)] <- "AM 06"
seuratM$patient[which(seuratM$dataset %in% Immpath_35)] <- "AM 07"
seuratM$patient[which(seuratM$dataset %in% Immpath_37)] <- "AM 08"
seuratM$patient[which(seuratM$dataset %in% Immpath_47)] <- "AM 09"
seuratM$patient[which(seuratM$dataset %in% Immpath_48)] <- "AM 10"

seuratM$patient[which(seuratM$dataset %in% pat_NCR30)] <- "AM 11"
seuratM$patient[which(seuratM$dataset %in% pat_NCR31)] <- "AM 12"
seuratM$patient[which(seuratM$dataset %in% pat_NCRGraz1)] <- "AM 13"
seuratM$patient[which(seuratM$dataset %in% pat_NCRGraz2)] <- "AM 14"
seuratM$patient[which(seuratM$dataset %in% pat_NCRGraz15)] <- "AM 15"

seuratM$patient[which(seuratM$dataset %in% pat_BLn979)] <- "AM 16"
seuratM$patient[which(seuratM$dataset %in% pat_BLn1537)] <- "AM 17"
seuratM$patient[which(seuratM$dataset %in% pat_BLn1041)] <- "AM 18"
seuratM$patient[which(seuratM$dataset %in% pat_BLn1235)] <- "AM 19"
seuratM$patient[which(seuratM$dataset %in% pat_BLn1383)] <- "AM 20"
seuratM$patient[which(seuratM$dataset %in% pat_BLn694)] <- "AM 21"
seuratM$patient[which(seuratM$dataset %in% Immpath_39)] <- "AM 22"
seuratM$patient[which(seuratM$dataset %in% Immpath_14)] <- "AM 23"
seuratM$patient[which(seuratM$dataset %in% pat_NCR29)] <- "AM 24"


seuratM$patient[which(seuratM$dataset %in% Immpath_24)] <- "CMP 01"
seuratM$patient[which(seuratM$dataset %in% Immpath_25)] <- "CMP 02"
seuratM$patient[which(seuratM$dataset %in% Immpath_30)] <- "CMP 03"
seuratM$patient[which(seuratM$dataset %in% pat_NCR32)] <- "CMP 04"
seuratM$patient[which(seuratM$dataset %in% pat_NCR34)] <- "CMP 05"
seuratM$patient[which(seuratM$dataset %in% CM_Graz7)] <- "CMP 06"
seuratM$patient[which(seuratM$dataset %in% CM_Graz14)] <- "CMP 07"
seuratM$patient[which(seuratM$dataset %in% CM_Graz18)] <- "CMP 08"
seuratM$patient[which(seuratM$dataset %in% CM_Graz3)] <- "CMP 09"
seuratM$patient[which(seuratM$dataset %in% CM_Graz4)] <- "CMP 10"
seuratM$patient[which(seuratM$dataset %in% CM_Graz5)] <- "CMP 11"
seuratM$patient[which(seuratM$dataset %in% CM_Graz6)] <- "CMP 12"
seuratM$patient[which(seuratM$dataset %in% CM_Graz19)] <- "CMP 13"


seuratM$patient[which(seuratM$dataset %in% Sarco_SG35)] <- "Sarcoidosis 01"
seuratM$patient[which(seuratM$dataset %in% Sarco_Graz20)] <- "Sarcoidosis 02"


## Allocate to condition
Healthy <- c("o28576_1_08-8_20220525_Hu_nucseq_Graz_8_HH_GEM",
             "o28576_1_09-9_20220525_Hu_nucseq_Graz_9_HH_GEM",
             "o28576_1_10-10_20220525_Hu_nucseq_Graz_10_HH_GEM",
             "o28576_1_11-11_20220525_Hu_nucseq_Graz_11_HH_GEM",
             "o28576_1_12-12_20220525_Hu_nucseq_Graz_12_HH_GEM",
             "o292731_1-1_20220818_Hu_nucseq_Graz_9_HH_GEM",
             "o292731_2-2_20220818_Hu_nucseq_Graz_13_HH_GEM",
             "o294781_01-1_20220912_Hu_nucseq_Graz_21_HH_GEM",
             "o294781_02-2_20220912_Hu_nucseq_Graz_22_HH_GEM",
             "o294781_03-3_20220912_Hu_nucseq_Graz_23_HH_GEM",
             "o294781_04-4_20220912_Hu_nucseq_Graz_24_HH_GEM")

AM <- c("o292731_3-3_20220818_Hu_nucseq_SG_33_EMB_GEM",
        "312581_05-5_20230308_Hu_nucseq_SG36_EMB_GEM",
        "312581_06-6_20230308_Hu_nucseq_SG37_EMB_GEM",
        "353921_28-28_20240529_Hu_nucseq_Immpath_EMB18",
        "353921_31-31_20240529_Hu_nucseq_Immpath_EMB27",
        "353921_32-32_20240529_Hu_nucseq_Immpath_EMB29",
        "353921_34-34_20240529_Hu_nucseq_Immpath_EMB35",
        "353921_35-35_20240529_Hu_nucseq_Immpath_EMB37",
        "359861_16-8_20240730_Hu_nucseq_Immpath_EMB47",
        "359861_17-9_20240730_Hu_nucseq_Immpath_EMB48",
        "o28576_1_01-1_20220525_Hu_nucseq_Graz_1_EMB_GEM",
        "o28576_1_02-2_20220525_Hu_nucseq_Graz_2_EMB_GEM",
        "o294781_06-6_20220912_Hu_nucseq_Graz_15_EMB_GEM",
        "o27533_1_12-12_20220203_Hu_nucseq_EMB31_GEM",
        "o27936_1_7-7_20220309_Hu_nucseq_EMB32_GEM",
        "359861_09-11_20240723_Hu_nucseq_Ber_Pat5_EM979_1","359861_10-13_20240723_Hu_nucseq_Ber_Pat5_EM979_2",
        "359861_11-1_20240730_Hu_nucseq_Ber_Pat1_EMB1537",
        "359861_12-2_20240730_Hu_nucseq_Ber_Pat2_EMB1041")

CMP <- c("353921_29-29_20240529_Hu_nucseq_Immpath_EMB24",
         "353921_30-30_20240529_Hu_nucseq_Immpath_EMB25",
         "353921_33-33_20240529_Hu_nucseq_Immpath_EMB30",
         "o28576_1_13-13_20220525_Hu_nucseq_EMB32_GEM",
         "o292731_4-4_20220818_Hu_nucseq_SG_34_EMB_GEM",
         "o28576_1_07-7_20220525_Hu_nucseq_Graz_7_EMB_GEM",
         "o294781_05-5_20220912_Hu_nucseq_Graz_14_EMB_GEM",
         "o294781_09-9_20220912_Hu_nucseq_Graz_18_EMB_GEM",
         "o28576_1_03-3_20220525_Hu_nucseq_Graz_3_EMB_GEM",
         "o28576_1_04-4_20220525_Hu_nucseq_Graz_4_EMB_GEM",
         "o28576_1_05-5_20220525_Hu_nucseq_Graz_5_EMB_GEM",
         "o28576_1_06-6_20220525_Hu_nucseq_Graz_6_EMB_GEM",
         "o294781_10-10_20220912_Hu_nucseq_Graz_19_EMB_GEM")

Sarcoidosis <- c("o292731_5-5_20220818_Hu_nucseq_SG_35_EMB_GEM",
                 "o294781_11-11_20220912_Hu_nucseq_Graz_20_EMB_GEM")

## Subgroup MCeos, Immpath_39 (bad Quality); Immpath_47, Berlin 1041
## Subgroup Giant cell: Immpath_29, 1537_BLn"


seuratM$pat_sub <- "pat_sub"
seuratM$pat_sub[which(seuratM$dataset %in% Healthy)] <- "Healthy"
seuratM$pat_sub[which(seuratM$dataset %in% AM)] <- "AM"
seuratM$pat_sub[which(seuratM$dataset %in% CMP)] <- "CMP"
seuratM$pat_sub[which(seuratM$dataset %in% Sarcoidosis)] <- "Sarcoidosis"

diseaseCond <- c("Healthy", "AM", "CMP", "Sarcoidosis")

table(seuratM$pat_sub)

table(seuratM$patient)
table(seuratM$orig.ident)

```


```{r}

## Allocate to sex

# in brackets insufficient quality, therefore not included
# female: AM01, AM04, AM06, AM07, AM09, AM10, AM14, AM16, AM18 (AM19, AM22, AM24)
# female: CMP02, CMP04, CMP13 
# male: AM02, AM03, AM05, AM08, AM11, AM12, AM13, AM15, AM17, (AM20, AM21, AM23)
# male CMP: CMP01, CMP03, CMP05,CMP06,CMP07,CMP08,CMP09,CMP10, CMP11, CMP12, Sarcoidosis 01, Sarcoidosis 02 

female <- c("o292731_3-3_20220818_Hu_nucseq_SG_33_EMB_GEM", #AM
            "353921_28-28_20240529_Hu_nucseq_Immpath_EMB18",
            "353921_32-32_20240529_Hu_nucseq_Immpath_EMB29",
            "353921_34-34_20240529_Hu_nucseq_Immpath_EMB35",
            "359861_16-8_20240730_Hu_nucseq_Immpath_EMB47",
            "359861_17-9_20240730_Hu_nucseq_Immpath_EMB48",
            "o28576_1_02-2_20220525_Hu_nucseq_Graz_2_EMB_GEM",
            "359861_09-11_20240723_Hu_nucseq_Ber_Pat5_EM979_1","359861_10-13_20240723_Hu_nucseq_Ber_Pat5_EM979_2",
            "359861_12-2_20240730_Hu_nucseq_Ber_Pat2_EMB1041", 
            "353921_30-30_20240529_Hu_nucseq_Immpath_EMB25", #CMP
            "o28576_1_13-13_20220525_Hu_nucseq_EMB32_GEM",
            "o294781_10-10_20220912_Hu_nucseq_Graz_19_EMB_GEM")

male <- c("312581_05-5_20230308_Hu_nucseq_SG36_EMB_GEM", #AM
          "312581_06-6_20230308_Hu_nucseq_SG37_EMB_GEM",
          "353921_31-31_20240529_Hu_nucseq_Immpath_EMB27",
          "353921_35-35_20240529_Hu_nucseq_Immpath_EMB37",
          "o27533_1_12-12_20220203_Hu_nucseq_EMB31_GEM",
          "o27936_1_7-7_20220309_Hu_nucseq_EMB32_GEM",
          "o28576_1_01-1_20220525_Hu_nucseq_Graz_1_EMB_GEM",
          "o294781_06-6_20220912_Hu_nucseq_Graz_15_EMB_GEM",
          "359861_11-1_20240730_Hu_nucseq_Ber_Pat1_EMB1537",
          "353921_29-29_20240529_Hu_nucseq_Immpath_EMB24", #CMP
          "353921_33-33_20240529_Hu_nucseq_Immpath_EMB30",
          "o292731_4-4_20220818_Hu_nucseq_SG_34_EMB_GEM",
          "o28576_1_07-7_20220525_Hu_nucseq_Graz_7_EMB_GEM",
          "o294781_05-5_20220912_Hu_nucseq_Graz_14_EMB_GEM",
          "o294781_09-9_20220912_Hu_nucseq_Graz_18_EMB_GEM",
          "o28576_1_03-3_20220525_Hu_nucseq_Graz_3_EMB_GEM",
          "o28576_1_04-4_20220525_Hu_nucseq_Graz_4_EMB_GEM",
          "o28576_1_05-5_20220525_Hu_nucseq_Graz_5_EMB_GEM",
         "o28576_1_06-6_20220525_Hu_nucseq_Graz_6_EMB_GEM",
         "o292731_5-5_20220818_Hu_nucseq_SG_35_EMB_GEM", # Sarcoidosis
         "o294781_11-11_20220912_Hu_nucseq_Graz_20_EMB_GEM")

# All Healthies unknown sex
unknown <- c("o28576_1_08-8_20220525_Hu_nucseq_Graz_8_HH_GEM", 
             "o28576_1_12-12_20220525_Hu_nucseq_Graz_12_HH_GEM",
             "o292731_1-1_20220818_Hu_nucseq_Graz_9_HH_GEM",
             "o292731_2-2_20220818_Hu_nucseq_Graz_13_HH_GEM",
             "o294781_01-1_20220912_Hu_nucseq_Graz_21_HH_GEM",
             "o294781_02-2_20220912_Hu_nucseq_Graz_22_HH_GEM",
             "o294781_03-3_20220912_Hu_nucseq_Graz_23_HH_GEM",
             "o294781_04-4_20220912_Hu_nucseq_Graz_24_HH_GEM")

seuratM$sex <- "sex"
seuratM$sex[which(seuratM$dataset %in% female)] <- "female"
seuratM$sex[which(seuratM$dataset %in% male)] <- "male"
seuratM$sex[which(seuratM$dataset %in% unknown)] <- "unknown"

table(seuratM$sex)

```


```{r}


# Allocate Ventricle
RV <- c("o292731_3-3_20220818_Hu_nucseq_SG_33_EMB_GEM", 
        "353921_28-28_20240529_Hu_nucseq_Immpath_EMB18",
        "353921_32-32_20240529_Hu_nucseq_Immpath_EMB29",
        "353921_34-34_20240529_Hu_nucseq_Immpath_EMB35",
        "359861_16-8_20240730_Hu_nucseq_Immpath_EMB47",
        "359861_17-9_20240730_Hu_nucseq_Immpath_EMB48",
        "o28576_1_02-2_20220525_Hu_nucseq_Graz_2_EMB_GEM",
        "353921_30-30_20240529_Hu_nucseq_Immpath_EMB25", 
        "o28576_1_13-13_20220525_Hu_nucseq_EMB32_GEM",
        "o294781_10-10_20220912_Hu_nucseq_Graz_19_EMB_GEM",
        "312581_05-5_20230308_Hu_nucseq_SG36_EMB_GEM",
        "312581_06-6_20230308_Hu_nucseq_SG37_EMB_GEM",
        "353921_31-31_20240529_Hu_nucseq_Immpath_EMB27",
        "353921_35-35_20240529_Hu_nucseq_Immpath_EMB37",
        "o27533_1_12-12_20220203_Hu_nucseq_EMB31_GEM",
        "o27936_1_7-7_20220309_Hu_nucseq_EMB32_GEM",
        "o28576_1_01-1_20220525_Hu_nucseq_Graz_1_EMB_GEM",
        "359861_11-1_20240730_Hu_nucseq_Ber_Pat1_EMB1537",
        "353921_29-29_20240529_Hu_nucseq_Immpath_EMB24", 
        "353921_33-33_20240529_Hu_nucseq_Immpath_EMB30",
        "o292731_4-4_20220818_Hu_nucseq_SG_34_EMB_GEM",
        "o28576_1_07-7_20220525_Hu_nucseq_Graz_7_EMB_GEM",
        "o294781_05-5_20220912_Hu_nucseq_Graz_14_EMB_GEM", 
        "o294781_09-9_20220912_Hu_nucseq_Graz_18_EMB_GEM",
        "o28576_1_03-3_20220525_Hu_nucseq_Graz_3_EMB_GEM",
        "o28576_1_04-4_20220525_Hu_nucseq_Graz_4_EMB_GEM",
        "o28576_1_05-5_20220525_Hu_nucseq_Graz_5_EMB_GEM",
        "o292731_5-5_20220818_Hu_nucseq_SG_35_EMB_GEM",
        "o28576_1_08-8_20220525_Hu_nucseq_Graz_8_HH_GEM", 
        "o28576_1_12-12_20220525_Hu_nucseq_Graz_12_HH_GEM",
        "o292731_1-1_20220818_Hu_nucseq_Graz_9_HH_GEM",
        "o292731_2-2_20220818_Hu_nucseq_Graz_13_HH_GEM",
        "o294781_01-1_20220912_Hu_nucseq_Graz_21_HH_GEM",
        "o294781_02-2_20220912_Hu_nucseq_Graz_22_HH_GEM",
        "o294781_03-3_20220912_Hu_nucseq_Graz_23_HH_GEM",
        "o294781_04-4_20220912_Hu_nucseq_Graz_24_HH_GEM")
  
LV <- c("359861_09-11_20240723_Hu_nucseq_Ber_Pat5_EM979_1", "359861_10-13_20240723_Hu_nucseq_Ber_Pat5_EM979_2",
      "359861_12-2_20240730_Hu_nucseq_Ber_Pat2_EMB1041",
      "359861_11-1_20240730_Hu_nucseq_Ber_Pat1_EMB1537",
      "o28576_1_06-6_20220525_Hu_nucseq_Graz_6_EMB_GEM",
      "o294781_06-6_20220912_Hu_nucseq_Graz_15_EMB_GEM",
      "o294781_11-11_20220912_Hu_nucseq_Graz_20_EMB_GEM")


seuratM$ventricle <- "ventricle"
seuratM$ventricle[which(seuratM$dataset %in% RV)] <- "RV"
seuratM$ventricle[which(seuratM$dataset %in% LV)] <- "LV"
table(seuratM$ventricle)


```








```{r Perform QC and extrat metadata from Seurat object with annotations}

##total is the sum of all counts while, detected means the number of different genes found

library(ggrepel)
library(dplyr)
library(geomtextpath)

meta.data <- seuratM@meta.data

# Density plot for 'total' counts, compare means and median
ptotalpat <- ggplot(data = meta.data, aes(x = total, color = patient, fill = patient)) +
  geom_density(alpha = 0.2) +
  theme_classic() +
  scale_x_log10() +
  ylab("Density") +
  geom_vline(xintercept = 100) +  # Add vertical line at intercept
  geom_text_repel(
    data = meta.data %>% group_by(patient) %>%
      summarise(total_median = median(total)) %>%
      filter(total_median < 300),  # Only label patients below the intercept
    aes(x = total_median, y = 0, label = patient),  # Place labels on the x-axis near the intercept
    size = 3, nudge_y = 2, segment.color = NA, hjust = "right"   # Set text color to black
  ) +
  labs(title = "Density Plot of Total Counts by Patient")

# Density plot for 'detected' counts
pdetectedpat <- ggplot(data = meta.data, aes(x = detected, color = patient, fill = patient)) +
  geom_density(alpha = 0.2) +
  theme_classic() +
  scale_x_log10() +
  ylab("Density") +
  geom_vline(xintercept = 100) +  # Add vertical line at intercept
  geom_text_repel(
    data = meta.data %>% group_by(patient) %>%
      summarise(detected_median = median(detected)) %>%
      filter(detected_median < 300),  # Only label patients below the intercept
    aes(x = detected_median, y = 0, label = patient),  # Place labels on the x-axis near the intercept
    size = 3, nudge_y = 2,segment.color = NA, hjust = "middle", color = "black"  # Set text color to black
  ) +
  labs(title = "Density Plot of Detected Counts by Patient")

# Return the plots as a list
list(ptotalpat, pdetectedpat)
```







```{r remove seurat objects with poor quality }
### remove 8 Samples from 7 patients due to different batch effect and low density
## remove "HH_11" <- c("o28576_1_09-9_20220525_Hu_nucseq_Graz_9_HH_GEM")
## remove Immpath_AM_39 (= "AM 24", "347741_6-6_20240326_Hu_nucseq_Immpath_AM39_0", "348751_1-6_20240326_Hu_nucseq_Immpath_AM39_0_rep")
## remove Immpath_14 = "312581_07-7_20230308_Hu_nucseq_SG38_EMB_GEM" = SG38
## remove "pat_NCR29", "o27533_1_11-11_20220203_Hu_nucseq_EMB30_GEM"
## remove "BLn_AM1235"; "359861_13-5_20240730_Hu_nucseq_Ber_Pat6_EMB1235"
## remove "BLn_AM1383", "359861_14-6_20240730_Hu_nucseq_Ber_Pat7_EMB1383"
## remove "BLn_AM694","359861_15-7_20240730_Hu_nucseq_Ber_Pat8_EMB694"
## remove Graz 10 and 11, formally labelled as HH2 and HH3, now relabbeld as HH09 and HH10 
## ("o28576_1_10-10_20220525_Hu_nucseq_Graz_10_HH_GEM"), ("o28576_1_11-11_20220525_Hu_nucseq_Graz_11_HH_GEM")


seuratM_filt <- subset(seuratM, dataset %in% c("o28576_1_09-9_20220525_Hu_nucseq_Graz_9_HH_GEM",
                                          "347741_6-6_20240326_Hu_nucseq_Immpath_AM39_0",
                                          "348751_1-6_20240326_Hu_nucseq_Immpath_AM39_0_rep",
                                          "312581_07-7_20230308_Hu_nucseq_SG38_EMB_GEM", 
                                          "o27533_1_11-11_20220203_Hu_nucseq_EMB30_GEM",
                                          "359861_13-5_20240730_Hu_nucseq_Ber_Pat6_EMB1235",
                                          "359861_14-6_20240730_Hu_nucseq_Ber_Pat7_EMB1383",
                                          "359861_15-7_20240730_Hu_nucseq_Ber_Pat8_EMB694",
                                          "o28576_1_10-10_20220525_Hu_nucseq_Graz_10_HH_GEM",
                                          "o28576_1_11-11_20220525_Hu_nucseq_Graz_11_HH_GEM"), invert = TRUE)


seuratM <- seuratM_filt
remove(seuratM_filt)
table(seuratM$orig.ident)

                         
unique(seuratM$dataset)
table(seuratM$dataset)
table(seuratM$orig.ident)

## new total cell count = 74070
```


```{r check cell count after removing samples }
cell_count <- data.frame(table(seuratM$pat_sub))
colnames(cell_count) <- c("Condition", "Freq")
hsize <- 1.5

ggplot(cell_count, aes(x = hsize, y = Freq, fill = Condition)) +
  #scale_fill_manual(values = colpat2) +
  geom_col(color = "white") +
  coord_polar(theta = "y") +
  xlim(c(0.2, hsize + 0.5)) +
  theme_void() +
  ggtitle("cell number") +
  theme(plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_text(aes(label = Freq), position = position_stack(vjust = 0.5))

# AM 29076, CMP 11635, Healthy 28290, Sarcoidosis 5069 


```


```{r}
cell_count <- data.frame(table(seuratM$patient))
colnames(cell_count) <- c("Patient", "Freq")
hsize <- 1.5

ggplot(cell_count, aes(x = hsize, y = Freq, fill = Patient)) +
  #scale_fill_manual(values = colpat2) +
  geom_col(color = "white") +
  coord_polar(theta = "y") +
  xlim(c(0.2, hsize + 0.5)) +
  theme_void() +
  ggtitle("cell number") +
  theme(plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_text(aes(label = Freq), position = position_stack(vjust = 0.5), size = 3, angle = 30)



table(seuratM$patient)

#Healthy 01     Healthy 02     Healthy 03     Healthy 04     Healthy 05     Healthy 06     Healthy 07     Healthy 08 
#         3921           3818           4908           9882           1442           1998            841           1480 

#       AM 01          AM 02          AM 03          AM 04          AM 05          AM 06          AM 07          AM 08 
#          6286           4323           1123            208            579            335           1217            604 

#       AM 09          AM 10          AM 11          AM 12          AM 13          AM 14          AM 15          AM 16 
#          513            426            236           1192           2740           1684           4439           2247 

#         AM 17          AM 18         CMP 01         CMP 02         CMP 03         CMP 04         CMP 05         CMP 06 
#           316            608            105            227            730           1428            620            653 
#        CMP 07         CMP 08         CMP 09         CMP 10         CMP 11         CMP 12         CMP 13          
#          1268           2280           2396            545            781            491            111          

# Sarcoidosis 01 (N = 2363),Sarcoidosis 02 (N = 2706) 
```


```{r}
## QC after samples were removed; total is the sum of all counts while, detected means the number of different genes found

meta.data <- seuratM@meta.data
# Density plot for 'total' counts, compare means and median
ptotalpat <- ggplot(data = meta.data, aes(x = total, color = patient, fill = patient)) +
  geom_density(alpha = 0.2) +
  theme_classic() +
  scale_x_log10() +
  ylab("Density") +
  geom_vline(xintercept = 100) +  # (+ vertical line intercept)
  geom_text_repel(
    data = meta.data %>% group_by(patient) %>%
      summarise(total_median = median(total)) %>%
      filter(total_median < 300),  
    aes(x = total_median, y = 0, label = patient),  
    size = 3, nudge_y = 2, segment.color = NA, hjust = "right"   
  ) +
  labs(title = "Density Plot of Total Counts by Patient")

# Density plot for 'detected' counts
pdetectedpat <- ggplot(data = meta.data, aes(x = detected, color = patient, fill = patient)) +
  geom_density(alpha = 0.2) +
  theme_classic() +
  scale_x_log10() +
  ylab("Density") +
  geom_vline(xintercept = 100) +  
  geom_text_repel(
    data = meta.data %>% group_by(patient) %>%
      summarise(detected_median = median(detected)) %>%
      filter(detected_median < 300), 
    aes(x = detected_median, y = 0, label = patient),  
    size = 3, nudge_y = 2,segment.color = NA, hjust = "middle", color = "black"  
  ) +
  labs(title = "Density Plot of Detected Counts by Patient")

# Return the plots as a list
list(ptotalpat, pdetectedpat)

```



```{r}

#Run seurat
seuratM <- NormalizeData (object = seuratM)
seuratM <- FindVariableFeatures(object = seuratM)
seuratM <- ScaleData(object = seuratM, verbose = TRUE)
seuratM <- RunPCA(object=seuratM, npcs = 30, verbose = FALSE)
seuratM <- RunTSNE(object=seuratM, reduction="pca", dims = 1:20)
seuratM <- RunUMAP(object=seuratM, reduction="pca", dims = 1:20)
seuratM <- FindNeighbors(object = seuratM, reduction = "pca", dims= 1:20)

ElbowPlot (seuratM)
# ranks principle components (PC) based on the percentage of variance explained by each one. In this example the elbow is around 15. This suggests that # the majority of true signal is captured in the first 15 PCA

res <- c(0.25, 0.6, 0.8, 0.4)
for (i in 1:length(res)) {
  seuratM <- FindClusters(object = seuratM, resolution = res[i], random.seed = 1234)
}
### save seurat object
#saveRDS(seuratM, file="/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/01 Merged Seurat files/Myocarditis_allfiltered_19.09.24.rds")

Idents(seuratM) <- seuratM$RNA_snn_res.0.25
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

DimPlot(seuratM, reduction = "pca", pt.size = 0.1, label = TRUE)

DimPlot(seuratM, reduction = "tsne", pt.size = 0.1, label = TRUE)

seuratM[["percent.mt"]] <- PercentageFeatureSet(seuratM, pattern = "^MT-")
VlnPlot(seuratM, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"))

res <- c(0.25, 0.6, 0.8, 0.4)
for (i in 1:length(res)) {
  seuratM <- FindClusters(object = seuratM, resolution = res[i], random.seed = 1234)
}
Idents(seuratM) <- seuratM$RNA_snn_res.0.25
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)




```

```{r Plot cell numbers per cluster}

#Plot cell count per cluster
cell_count_cluster <- data.frame(table(seuratM$RNA_snn_res.0.25))
colnames(cell_count_cluster) <- c("clusterName", "Freq")
hsize <- 1.5

ggplot(cell_count_cluster, aes(x = clusterName, y = Freq, fill = clusterName)) +
  geom_col(color = "white") +  # Use geom_col for a bar plot
  theme_classic() +  
  ggtitle("Cell Number by Cluster") +
  theme(plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_text(aes(label = Freq), vjust = -0.3, size = 3) +  # labels above bars
  xlab("Cluster Names") +  
  ylab("Frequency (Cell Count)")  

# Plot cell count per condition



```



```{r Plot cluster per patient}

## under construction
#Plot cell count per cluster
cell_count_patient <- data.frame(table(seuratM$patient))
colnames(cell_count_patient) <- c("Patient", "Freq")
hsize <- 1.5

ggplot(cell_count_patient, aes(x = Patient, y= Freq, fill = Patient) +
  geom_bar (color = "white") +  
  theme_classic() +  # 
  ggtitle("Cell Number per patient") +
  theme(plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_text(aes(label = Freq), vjust = -0.3, size = 3) +  # text labels above bars
  xlab("Patients"))   # X-axis label
  


```


```{r Save merged and cleaned file}
##

#saveRDS(seuratM, file="/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/01 Merged Seurat files/Myocarditis_allfiltered_19.09.24.rds")


```

```{r Cluster by condition (=pat_sub) and by patient}

Idents(seuratM) <- seuratM$RNA_snn_res.0.25
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

Idents(seuratM) <- seuratM$pat_sub
order1 <- c("Healthy","AM","CMP","Sarcoidosis")
seuratM$pat_sub <- factor (seuratM$pat_sub, levels = c("Healthy", "AM", "CMP", "Sarcoidosis"))
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, group.by = "pat_sub")


# Order of patient levels numerically
seuratM$patient <- factor(seuratM$patient, levels = c("Healthy 01", "Healthy 02", "Healthy 03", "Healthy 04", "Healthy 05", "Healthy 06", "Healthy 07", "Healthy 08", "AM 01", "AM 02", "AM 03", "AM 04", "AM 05", "AM 06", "AM 07", "AM 08", "AM 09", "AM 10", "AM 11", "AM 12", "AM 13", "AM 14", "AM 15", "AM 16", "AM 17", "AM 18", "CMP 01", "CMP 02", "CMP 03", "CMP 04", "CMP 05", "CMP 06", "CMP 07", "CMP 08", "CMP 09", "CMP 10", "CMP 11", "CMP 12", "CMP 13", "Sarcoidosis 01","Sarcoidosis 02"))

Idents(seuratM) <- seuratM$patient
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, raster = FALSE)

```

```{r Plot umap for each condition}

###combined slots
seuratM$patient_pat_sub <- paste0(seuratM$patient, '_', seuratM$pat_sub)
table(seuratM$patient_pat_sub)

colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")
names(colpat_sub) <- c("Healthy", "AM", "CMP", "Sarcoidosis")

Idents(seuratM) <- seuratM$pat_sub
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, cols = colpat_sub, order = order1, raster=FALSE)

seuratHealthy <- subset(seuratM, pat_sub == "Healthy")
DimPlot(seuratHealthy, reduction = "umap", pt.size = 0.1, cols = colpat_sub, raster=FALSE)

seuratAM <- subset(seuratM, pat_sub == "AM")
DimPlot(seuratAM, reduction = "umap", pt.size = 0.1, cols = colpat_sub, raster= FALSE)

seuratCMP <- subset(seuratM, pat_sub == "CMP")
DimPlot(seuratCMP, reduction = "umap", pt.size = 0.1, cols = colpat_sub, raster =FALSE)

seuratSarcoidosis <- subset(seuratM, pat_sub == "Sarcoidosis")
DimPlot(seuratSarcoidosis, reduction = "umap", pt.size = 0.1, cols = colpat_sub, raster = FALSE)



```

```{r generate orignal umap and heatmap to find features of each cluster}
Idents(seuratM) <- seuratM$RNA_snn_res.0.25
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)

```

```{r Identify marker genes}
# Examine PCA results and find the top marker genes
print(seuratM[["umap"]], dims = 1:20, nfeatures = 10)

##cluster marker
markers <- FindAllMarkers(seuratM, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01)

# View the top markers per cluster
print(markers)

#save table
#write.table(markers,file= "/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/docs/Markers_all_filtered_25_09_24", sep="\t",quote=F,row.names=F,col.names=T)

```



```{r check features and markers}
get_full_gene_name <- function(gene, obj){
  return(grep(gene,rownames(obj), value =TRUE))
}
get_full_gene_name("CD3E",seuratM) 



# Visualize the expression of specific marker genes on UMAP
FeaturePlot(seuratM, features = "ENSG00000164692.COL1A2", pt.size = 1, cols = c("lightgrey", "#BE3144")) # Fibroblast
FeaturePlot(seuratM, features = "ENSG00000142173.COL6A2", pt.size = 1, cols = c("lightgrey", "#BE3144")) # Fibroblast
FeaturePlot(seuratM, features = "ENSG00000113721.PDGFRB", pt.size = 1, cols = c("lightgrey", "#BE3144")) # Fibroblast
FeaturePlot(seuratM, features = "ENSG00000135424.ITGA7", pt.size = 1, cols = c("lightgrey", "#BE3144")) # Fibroblast

FeaturePlot(seuratM, features = "ENSG00000143248.RGS5", pt.size = 1, cols = c("lightgrey", "#BE3144")) # Perivasc Fibroblast

FeaturePlot(seuratM, features = "ENSG00000110799.VWF", pt.size = 1, cols = c("lightgrey", "#BE3144")) # ECs

FeaturePlot(seuratM, features = "ENSG00000179776.CDH5", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000174059.CD34", pt.size = 1, cols = c("lightgrey", "#BE3144")) # endothelial cells

FeaturePlot(seuratM, features = "ENSG00000118194.TNNT2", pt.size = 1, cols = c("lightgrey", "#BE3144")) # cardiomyocyte
FeaturePlot(seuratM, features = get_full_gene_name("MYH6",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#CM
FeaturePlot(seuratM, features = "ENSG00000078814.MYH7B", pt.size = 1, cols = c("lightgrey", "#BE3144")) # cardiomyocyte

FeaturePlot(seuratM, features = "ENSG00000163110.PDLIM5", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000177575.CD163", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000182578.CSF1R", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000081237.PTPRC", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000168685.IL7R", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("CD3E",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("CD3D",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("CD3G",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("CD79B",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("JCHAIN",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("S100A9",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144")) #neutrophil
FeaturePlot(seuratM, features = get_full_gene_name("HLA-DMB",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144")) #MHC expressing macrophages
FeaturePlot(seuratM, features = get_full_gene_name("ACACB",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#adipocytes
FeaturePlot(seuratM, features = get_full_gene_name("PLIN1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#adipocytes
FeaturePlot(seuratM, features = get_full_gene_name("GPAM",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#adipocytes
FeaturePlot(seuratM, features = get_full_gene_name("ITGA7",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#also adipocytes
FeaturePlot(seuratM, features = get_full_gene_name("ITGA1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000185811.IKZF1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000198851.CD3E", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000139187.KLRG1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000110324.IL10RA", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000011465.DCN", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000175084.DES", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000133110.POSTN", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000261371.PECAM1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("ITGA10",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# BEC
FeaturePlot(seuratM, features = get_full_gene_name("CDH11",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# BEC
FeaturePlot(seuratM, features = "ENSG00000133392.MYH11", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000107796.ACTA2", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = get_full_gene_name("EGFL7",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# EC BEC und LEC
FeaturePlot(seuratM, features = get_full_gene_name("CDH11",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#endothelial cells
FeaturePlot(seuratM, features = get_full_gene_name("CCL21",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# LEC
FeaturePlot(seuratM, features = get_full_gene_name("PROX1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# LEC
FeaturePlot(seuratM, features = get_full_gene_name("FLT4",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# LEC
FeaturePlot(seuratM, features = get_full_gene_name("LYVE1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# 
# Feature Plot(seuratM, features = get_full_gene_name("LY6C", seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#

FeaturePlot(seuratM, features = "ENSG00000149591.TAGLN", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000138755.CXCL9", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000169245.CXCL10", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000137573.SULF1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000125378.BMP4", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("GREM1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#
FeaturePlot(seuratM, features = get_full_gene_name("GREM2",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = "ENSG00000211592.IGKC", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000078098.FAP", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000179915.NRXN1", pt.size = 1, cols = c("lightgrey", "#BE3144")) # neuron
FeaturePlot(seuratM, features = "ENSG00000198910.L1CAM", pt.size = 1, cols = c("lightgrey", "#BE3144"))

FeaturePlot(seuratM, features = get_full_gene_name("CD79A",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("IGHM",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("CD20",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("MS4A1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells MS4A1 (CD20)
FeaturePlot(seuratM, features = get_full_gene_name("IGHM",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("BLNK",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("IGHM",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# B cells
FeaturePlot(seuratM, features = get_full_gene_name("PRDM1",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))# Plasma cells PRDM1 (Blimp-1)
FeaturePlot(seuratM, features = get_full_gene_name("IRF4",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))#  Plasma cells
```





```{r check BMP4 and GREMs}

colclusterName <- c("#D53E4F", "#f4a582", "#FEE08B","#feb24c","#67001f", "#01665e","#66C2A5","#c7eae5","#BEAED4", "#355C7D","#3288BD","#8c510a" ,"#fde0dd","#B45B5C","#dd1c77")

                    
names(colclusterName) <- c("Cardiomyocyte","Fb1","Fb2","Fb3", "INT1", "PeriFb1", "PeriFb2", "VSMC","NC", "BEC1","BEC2", "AdipoC", "MCP1","MCP2","TC")

                  

colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")


      

VlnPlot(seuratM, features = "ENSG00000125378.BMP4", pt.size = 0.1) +
  scale_fill_manual(values = c("#D53E4F", "#f4a582", "#FEE08B","#feb24c","#67001f", "#01665e","#66C2A5","#c7eae5","#BEAED4", "#355C7D","#3288BD","#8c510a" ,"#fde0dd","#B45B5C","#dd1c77"))

VlnPlot(seuratM, features = "ENSG00000125378.BMP4", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#dfc27d","#BE3144","#355C7D", "#779d8d"))


                  
```



```{r Cluster names}
#### Rename clusters

seuratM$clusterName <- "clusterName"

seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "0" )] <- "Fb1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "1" )] <- "BEC1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "2" )] <- "PeriFb1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "3" )] <- "Cardiomyocyte"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "4" )] <- "MCP1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "5" )] <- "TC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "6" )] <- "MCP2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "7" )] <- "BEC2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "8" )] <- "VSMC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "9" )] <- "NC"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "10" )] <- "INT1"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "11" )] <- "Fb2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "12" )] <- "Fb3"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "13" )] <- "PeriFb2"
seuratM$clusterName[which(seuratM$RNA_snn_res.0.25 %in% "14" )] <- "AdipoC"



Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE, cols = colclusterName)

```

```{r}


genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "TNNT2", "CMYA5", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB","ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "PROX1", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "ACACB", "PLIN1", "GPAM", "CD163", "MRC1", "SIGLEC1", "STAB1", "CSF1R", "MERTK", "IL7R", "PTPRC", "CD2"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 

DotPlot(seuratM, features = selGenes, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()

genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes_BMP4 <- data.frame(geneID=rev(c("BMP4", "GREM1", "GREM2"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 

DotPlot(seuratM, features = selGenes_BMP4, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()

```

```{r}
##cluster marker
Idents(seuratM) <- seuratM$clusterName
markerGenes <- FindAllMarkers(seuratM, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01)


seuratM$clusterName <- factor(seuratM$clusterName, levels=c("Cardiomyo", "Fb1", "Fb2", "Fb3", "INT1","PeriFb1", "PeriFb2", "VSMC", "NC", "BEC1", "BEC2", "AdipoC", "MCP1", "MCP2", "TC"))


Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)


genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "CMYA5", "COL6A3", "DCN", "BMP",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB","ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "SMOC1", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "PROX1", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "ACACB", "PLIN1", "GPAM", "CD163", "LYVE1", "HLA-DMB", "MRC1", "SIGLEC1", "STAB1", "CSF1R", "MERTK", "IL7R", "PTPRC", "CD2", "CD3E", "CD3D", "CD79B","JCHAIN", "KLRG1", "SIGL", "SEPTIN3","IGHM"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 

# Selected genes for DotPlot
selGenes <- data.frame(geneID = rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "CMYA5", 
                                      "COL6A3", "DCN", "BMP",  "FBN1", "C7", 
                                      "PDGFRA", "CDH19", "PDGFRB", "ITGA7", 
                                      "RGS5", "NOTCH3", "MYH11", "ACTA2", 
                                      "PECAM1", "VWF", "SMOC1", "EGFL7", 
                                      "POSTN", "ITGA10", "CDH11", "CCL21", 
                                      "PROX1", "FLT4", "NRXN1", "ANK3", 
                                      "PTPRZ1", "ACACB", "PLIN1", "GPAM", 
                                      "CD163", "LYVE1", "HLA-DMB", "MRC1", 
                                      "SIGLEC1", "STAB1", "CSF1R", "MERTK", 
                                      "IL7R", "PTPRC", "CD2", "CD3E", "CD3D", 
                                      "CD79B", "JCHAIN", "KLRG1", "SIGL", 
                                      "SEPTIN3", "IGHM"))) %>%
  left_join(genes, by = "geneID") %>%
  filter(geneID != "ENSG00000232995.RGS5")  # Exclude the specific gene if necessary


DotPlot(seuratM, features = selGenes$gene, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="T") + coord_flip()
```


```{r save File}

#saveRDS(seuratM, file="/Users/immbio/Desktop/Emily/Myocarditis snRNAseq/data/01 Merged Seurat files/Myocarditis_HH2_HH3_removed_V2_26.09.2024.rds")


```



```{r TC high vs. low}
colpat_sub<- c("#dfc27d","#BE3144","#355C7D", "#779d8d")

coldiseaseCond <- colpat_sub
names(coldiseaseCond) <- c("Healthy", "AM", "CMP", "Sarcoidosis")
order_coldiseaseCond <- c("Healthy", "AM", "CMP", "Sarcoidosis")

```


```


```{r Cluster names}


##cluster marker
Idents(seuratM) <- seuratM$clusterName
markerGenes <- FindAllMarkers(seuratM, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01)


seuratM$clusterName <- factor(seuratM$clusterName, levels=c("Cardiomyo", "Fb1", "Fb2", "Fb3", "INT1","PeriFb1", "PeriFb2", "VSMC", "NC", "BEC1", "BEC2", "AdipoC", "MCP1", "MCP2", "TC"))


Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap", pt.size = 0.1, label = TRUE)


genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "CMYA5", "COL6A3", "DCN", "BMP",  "FBN1", "C7", "PDGFRA", "CDH19", "PDGFRB","ITGA7","RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "SMOC1", "EGFL7", "POSTN", "ITGA10", "CDH11","CCL21", "PROX1", "FLT4", "NRXN1", "ANK3", "PTPRZ1", "ACACB", "PLIN1", "GPAM", "CD163", "LYVE1", "HLA-DMB", "MRC1", "SIGLEC1", "STAB1", "CSF1R", "MERTK", "IL7R", "PTPRC", "CD2", "CD3E", "CD3D", "CD79B","JCHAIN", "KLRG1", "SIGL", "SEPTIN3","IGHM"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 

# Selected genes for DotPlot
selGenes <- data.frame(geneID = rev(c("TTN", "MYBPC3", "RYR2", "NEBL", "CMYA5", 
                                      "COL6A3", "DCN", "BMP",  "FBN1", "C7", 
                                      "PDGFRA", "CDH19", "PDGFRB", "ITGA7", 
                                      "RGS5", "NOTCH3", "MYH11", "ACTA2", 
                                      "PECAM1", "VWF", "SMOC1", "EGFL7", 
                                      "POSTN", "ITGA10", "CDH11", "CCL21", 
                                      "PROX1", "FLT4", "NRXN1", "ANK3", 
                                      "PTPRZ1", "ACACB", "PLIN1", "GPAM", 
                                      "CD163", "LYVE1", "HLA-DMB", "MRC1", 
                                      "SIGLEC1", "STAB1", "CSF1R", "MERTK", 
                                      "IL7R", "PTPRC", "CD2", "CD3E", "CD3D", 
                                      "CD79B", "JCHAIN", "KLRG1", "SIGL", 
                                      "SEPTIN3", "IGHM"))) %>%
  left_join(genes, by = "geneID") %>%
  filter(geneID != "ENSG00000232995.RGS5")  # Exclude the specific gene if necessary


DotPlot(seuratM, features = selGenes$gene, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="T") + coord_flip()


```







```{r}

date()
sessionInfo()

```
